"use strict";(()=>{var e={};e.id=31,e.ids=[31],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9505:e=>{e.exports=import("socket.io")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,o){return o in t?t[o]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,o)):"function"==typeof t&&"default"===o?t:void 0}}})},4965:(e,t,o)=>{o.a(e,async(e,n)=>{try{o.r(t),o.d(t,{config:()=>l,default:()=>c,routeModule:()=>m});var i=o(1802),a=o(7153),r=o(6249),s=o(6539),d=e([s]);s=(d.then?(await d)():d)[0];let c=(0,r.l)(s,"default"),l=(0,r.l)(s,"config"),m=new i.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/socket",pathname:"/api/socket",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},6539:(e,t,o)=>{o.a(e,async(e,n)=>{try{o.r(t),o.d(t,{config:()=>s,default:()=>r});var i=o(9505),a=e([i]);i=(a.then?(await a)():a)[0];let s={api:{bodyParser:!1}},d=null,c=new Map,l=new Map,m=[],u=[],f=new Map,h="anon-chat-public",g=e=>e<=0?0:Math.floor(Math.random()*e),p=()=>{let e=(1e3+g(9e3)).toString();return`Stranger-${e}`},v=(e,t)=>{let o=e?.sockets?.adapter?.rooms?.get?.(t);return"number"==typeof o?.size?o.size:0},P=e=>{let t=v(e,h);e.to(h).emit("anon:chat:count",{room:h,count:t})},k=()=>[...c.keys()].sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"})),y=()=>k().map(e=>({username:e,id:c.get(e)})),A=()=>{d.emit("users:update",{users:k(),details:y()})},S=()=>[...f.keys()].sort(),j=()=>{d.emit("rooms:update",{rooms:S()})},b=(e,t)=>{let o=e.indexOf(t);o>=0&&e.splice(o,1)},w=(e,t,o,n)=>{let i=e.shift(),a=e.shift();if(!i||!a){i&&e.unshift(i);return}let r=`${t}-${Date.now()}-${i.slice(0,5)}-${a.slice(0,5)}`,s=d.sockets.sockets.get(i),c=d.sockets.sockets.get(a);s&&c&&("function"==typeof n&&n(s,c,r),s.join(r),c.join(r),s.emit(o,{room:r}),c.emit(o,{room:r}))},_=e=>{3!==e.__handlersVersion&&(e.removeAllListeners("connection"),e.on("connection",t=>{console.log(`Socket connected: ${t.id}`);try{t.on("user:register",e=>{let o=(e?.username??e?.email??"").trim();if(console.log(`Registering user: ${o} for socket: ${t.id}`),!o)return;let n=l.get(t.id);n&&n!==o&&c.get(n)===t.id&&c.delete(n),c.set(o,t.id),l.set(t.id,o),A()}),t.on("users:list",()=>{t.emit("users:update",{users:k(),details:y()})}),t.on("room:join",o=>{let{username:n,email:i,room:a}=o,r=(n??i??"").trim();r&&(c.set(r,t.id),l.set(t.id,r),A()),e.to(a).emit("user:joined",{username:r,id:t.id}),t.join(a),f.has(a)||f.set(a,new Set),f.get(a).add(t.id),j(),e.to(t.id).emit("room:join",o)}),t.on("room:leave",({room:e})=>{if(!e)return;t.leave(e);let o=f.get(e);o&&(o.delete(t.id),0===o.size&&f.delete(e)),j()}),t.on("rooms:list",()=>{t.emit("rooms:update",{rooms:S()})}),t.on("user:call",({to:o,offer:n})=>{e.to(o).emit("incomming:call",{from:t.id,offer:n})}),t.on("call:accepted",({to:o,ans:n})=>{e.to(o).emit("call:accepted",{from:t.id,ans:n})}),t.on("peer:nego:needed",({to:o,offer:n})=>{e.to(o).emit("peer:nego:needed",{from:t.id,offer:n})}),t.on("peer:nego:done",({to:o,ans:n})=>{e.to(o).emit("peer:nego:final",{from:t.id,ans:n})}),t.on("ice:candidate",({to:o,candidate:n})=>{e.to(o).emit("ice:candidate",{from:t.id,candidate:n})}),t.on("chat:join",({room:o})=>{o&&("string"==typeof o&&o.startsWith("anon-chat")&&!t.data?.anonChatName&&(t.data.anonChatName=p()),t.join(o),t.emit("chat:joined",{room:o}),o===h&&(P(e),t.emit("anon:chat:count",{room:h,count:v(e,h)})))}),t.on("chat:message",({room:o,message:n})=>{if(!o)return;let i=(n??"").toString().trim();if(!i)return;let a="string"==typeof o&&o.startsWith("anon-chat")?t.data?.anonChatName??"Stranger":l.get(t.id)??"Anonymous";e.to(o).emit("chat:message",{room:o,from:a,fromId:t.id,message:i,at:Date.now()})}),t.on("anon:chat:find",()=>{t.data?.anonChatName||(t.data.anonChatName=p()),t.join(h),t.emit("anon:chat:matched",{room:h})}),t.on("anon:chat:leave",()=>{b(m,t.id),t.data.anonChatName=void 0,t.leave(h),t.emit("anon:chat:left"),P(e)}),t.on("anon:video:find",()=>{u.includes(t.id)||(b(m,t.id),u.push(t.id),u.length>=2?w(u,"anon-video","anon:video:matched"):t.emit("anon:video:searching"))}),t.on("anon:video:leave",()=>{b(u,t.id),t.emit("anon:video:left")}),t.on("video:invite",({toEmail:o,room:n})=>{let i=(o??"").trim(),a=(n??"").trim();if(!i||!a)return;let r=c.get(i);if(!r)return;let s=l.get(t.id)??"Anonymous";e.to(r).emit("video:invite",{from:s,room:a})}),t.on("chat:invite",({toEmail:o,room:n})=>{let i=(o??"").trim(),a=(n??"").trim();if(!i||!a)return;let r=c.get(i);if(!r)return;let s=l.get(t.id)??"Anonymous";e.to(r).emit("chat:invite",{from:s,room:a})}),t.on("disconnect",()=>{let o=t.rooms?.has?.(h),n=l.get(t.id);for(let[e,o]of(n&&(l.delete(t.id),c.get(n)===t.id&&c.delete(n),A()),f.entries()))o.has(t.id)&&(o.delete(t.id),0===o.size&&f.delete(e));j(),t.data.anonChatName=void 0,b(m,t.id),b(u,t.id),o&&P(e)})}catch(e){console.log(e)}}),e.__handlersVersion=3,e.disconnectSockets(!0))};function r(e,t){try{let e=t.socket?.server;if(!e){t.status(500).end("No HTTP server available for Socket.IO");return}if(!d){let t=new i.Server(e,{path:"/api/socket",cors:{origin:!0},pingTimeout:3e5,ackTimeout:5e3,pingInterval:1e4});d=t,e.io=t}_(d),t.headersSent||t.end()}catch(e){console.error("Socket handler error",e),t.headersSent||t.status(500).end("Socket.IO error")}}n()}catch(e){n(e)}})},7153:(e,t)=>{var o;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(e,t,o)=>{e.exports=o(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var o=t(t.s=4965);module.exports=o})();