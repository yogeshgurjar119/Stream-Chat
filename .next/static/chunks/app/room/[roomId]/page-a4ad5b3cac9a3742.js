(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[684],{3611:function(e,t,r){Promise.resolve().then(r.bind(r,3354))},2710:function(e,t,r){"use strict";r.d(t,{Z:function(){return o},s:function(){return c}});var a=r(7437),n=r(2265);let i=(0,r(5040).io)("",{path:"/api/socket"}),s=(0,n.createContext)(i),c=()=>(0,n.useContext)(s);function o(e){let{children:t}=e;return(0,a.jsx)(s.Provider,{value:i,children:t})}},3354:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return m}});var a=r(7437),n=r(2265),i=r(8492),s=r.n(i),c=r(2710),o=r(8726);class l{initPeer(){this.peer=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]})}recreatePeer(){let e=this.peer;try{e&&e.close()}catch(e){}return this.initPeer(),this.peer}async getOffer(){this.peer||this.initPeer();let e=await this.peer.createOffer();return await this.peer.setLocalDescription(new RTCSessionDescription(e)),e}async getAnswer(e){this.peer||this.initPeer(),await this.peer.setRemoteDescription(e);let t=await this.peer.createAnswer();return await this.peer.setLocalDescription(new RTCSessionDescription(t)),t}async setRemoteDescription(e){this.peer||this.initPeer(),await this.peer.setRemoteDescription(new RTCSessionDescription(e))}getPeer(){return this.peer||this.initPeer(),this.peer}constructor(){this.peer=null,this.initPeer()}}let d=new l;function u(e){let{roomId:t}=e,r=(0,c.s)(),[i,l]=(0,n.useState)(!1),[u,m]=(0,n.useState)(null),[f,h]=(0,n.useState)(),[v,g]=(0,n.useState)(),[p,y]=(0,n.useState)(!!(null==r?void 0:r.connected)),[b,C]=(0,n.useState)(null),[k,w]=(0,n.useState)(0),j=(0,n.useRef)(!1),x=(0,n.useMemo)(()=>{var e;return"undefined"!=typeof localStorage?(null!==(e=localStorage.getItem("rt_username"))&&void 0!==e?e:"Anonymous").trim():"Anonymous"},[]),P=(0,n.useCallback)(e=>{let{username:t,id:r}=e;m(r)},[]),N=(0,n.useCallback)(e=>{let t=d.getPeer(),r=new Set(t.getSenders().map(e=>{var t;return null===(t=e.track)||void 0===t?void 0:t.id}));for(let a of Array.from(e.getTracks()).sort((e,t)=>"audio"===e.kind&&"video"===t.kind?-1:"video"===e.kind&&"audio"===t.kind?1:0))r.has(a.id)||t.addTrack(a,e)},[]),E=(0,n.useCallback)(()=>{d.recreatePeer(),w(e=>e+1)},[]),S=(0,n.useCallback)(async()=>{let e;try{e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),h(e),N(e);let t=await d.getOffer();r.emit("user:call",{to:u,offer:t})}catch(t){if(console.error("Error initiating call:",t),e&&("InvalidModificationError"===t.name||"InvalidStateError"===t.name))try{E(),N(e);let t=await d.getOffer();r.emit("user:call",{to:u,offer:t});return}catch(e){console.error("Retry failed:",e)}o.ZP.error("Failed to start call. Please check permissions.")}},[u,r,N,E]),R=(0,n.useCallback)(async e=>{let{from:t,offer:r}=e;m(t),C({from:t,offer:r})},[]),D=(0,n.useCallback)(async()=>{let e;if(b)try{e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),h(e),N(e);let t=await d.getAnswer(b.offer);r.emit("call:accepted",{to:b.from,ans:t}),C(null)}catch(t){if(console.error("Error accepting call:",t),e&&("InvalidModificationError"===t.name||"InvalidStateError"===t.name))try{E(),N(e);let t=await d.getAnswer(b.offer);r.emit("call:accepted",{to:b.from,ans:t}),C(null);return}catch(e){console.error("Retry failed:",e)}o.ZP.error("Failed to accept call. Please check permissions.")}},[b,N,r,E]),I=(0,n.useCallback)(()=>{C(null)},[]),O=(0,n.useCallback)(async()=>{if(f)try{if(N(f),u){let e=await d.getOffer();r.emit("peer:nego:needed",{to:u,offer:e}),o.ZP.success("Stream sent successfully")}}catch(e){if(console.error("Error initiating renegotiation:",e),"InvalidModificationError"===e.name||"InvalidStateError"===e.name)try{if(E(),N(f),u){let e=await d.getOffer();r.emit("peer:nego:needed",{to:u,offer:e}),o.ZP.success("Stream sent successfully (after retry)")}return}catch(e){console.error("Retry failed:",e)}o.ZP.error("Failed to send stream")}},[f,N,u,r,E]),L=(0,n.useCallback)(async e=>{let{ans:t}=e;try{await d.setRemoteDescription(t)}catch(e){console.error("Error setting remote description:",e),o.ZP.error("Failed to establish connection")}},[]);(0,n.useCallback)(async()=>{let e=await d.getOffer();r.emit("peer:nego:needed",{offer:e,to:u})},[u,r]);let A=(0,n.useCallback)(async e=>{let{from:t,offer:a}=e,n=await d.getAnswer(a);r.emit("peer:nego:done",{to:t,ans:n})},[r]),F=(0,n.useCallback)(async e=>{let{ans:t}=e;await d.setRemoteDescription(t)},[]);(0,n.useEffect)(()=>{let e=async e=>{g(e.streams[0])},t=d.getPeer();return t.addEventListener("track",e),()=>{t.removeEventListener("track",e)}},[k]),(0,n.useEffect)(()=>{let e=d.getPeer(),t=e=>{e.candidate&&r.emit("ice:candidate",{to:u,candidate:e.candidate})};return e.addEventListener("icecandidate",t),()=>{e.removeEventListener("icecandidate",t)}},[u,r,k]);let T=(0,n.useCallback)(async e=>{let{candidate:t}=e;try{let e=d.getPeer();await e.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.error("Error adding ICE candidate:",e)}},[]);return((0,n.useEffect)(()=>{let e=()=>y(!0),t=()=>y(!1);return r.on("connect",e),r.on("disconnect",t),y(!!(null==r?void 0:r.connected)),()=>{r.off("connect",e),r.off("disconnect",t)}},[r]),(0,n.useEffect)(()=>{l(!0)},[]),(0,n.useEffect)(()=>{t&&x&&(j.current||(j.current=!0,r.emit("user:register",{username:x}),r.emit("room:join",{username:x,room:t})))},[x,t,r]),(0,n.useEffect)(()=>(r.on("user:joined",P),r.on("incomming:call",R),r.on("call:accepted",L),r.on("peer:nego:needed",A),r.on("peer:nego:final",F),r.on("ice:candidate",T),()=>{r.off("user:joined",P),r.off("incomming:call",R),r.off("call:accepted",L),r.off("peer:nego:needed",A),r.off("peer:nego:final",F),r.off("ice:candidate",T)}),[r,P,R,L,A,F,T]),i)?(0,a.jsxs)("div",{className:"roomPage",children:[(0,a.jsxs)("div",{className:"roomTopBar",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h1",{className:"roomTitle",children:["Room ",t]}),(0,a.jsxs)("div",{className:"statusRow",children:[(0,a.jsxs)("span",{className:"badge ".concat(p?"badgeOk":"badgeWarn"),children:["Connection: ",p?"Online":"Offline"]}),(0,a.jsxs)("span",{className:"badge ".concat(u?"badgeOk":"badgeWarn"),children:["Peer: ",u?"Connected":"Waiting"]})]})]}),(0,a.jsxs)("div",{className:"buttonRow",children:[b?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"buttonPrimary",onClick:D,children:"Accept"}),(0,a.jsx)("button",{className:"buttonSecondary",onClick:I,children:"Decline"})]}):null,u&&!b?(0,a.jsx)("button",{className:"buttonPrimary",onClick:S,children:"Call"}):null,f&&(0,a.jsx)("button",{className:"buttonSecondary",onClick:O,children:"Send Stream"}),(0,a.jsx)("button",{className:"buttonSecondary",onClick:()=>(0,o.ZP)("Copy the room URL to invite someone"),children:"Invite"})]})]}),(0,a.jsxs)("div",{className:"videoGrid",children:[(0,a.jsxs)("div",{className:"videoCard",children:[(0,a.jsxs)("div",{className:"videoHeader",children:[(0,a.jsx)("div",{className:"videoLabel",children:"My Video"}),(0,a.jsx)("div",{className:"badge",children:f?"Ready":"Not started"})]}),(0,a.jsx)("div",{className:"videoFrame",children:f?(0,a.jsx)(s(),{className:"playerFill",playing:!0,muted:!0,url:f}):null})]}),(0,a.jsxs)("div",{className:"videoCard",children:[(0,a.jsxs)("div",{className:"videoHeader",children:[(0,a.jsx)("div",{className:"videoLabel",children:"Remote Video"}),(0,a.jsx)("div",{className:"badge",children:v?"Live":"Waiting"})]}),(0,a.jsx)("div",{className:"videoFrame",children:v?(0,a.jsx)(s(),{className:"playerFill",playing:!0,muted:!0,url:v}):null})]})]})]}):null}function m(e){let{params:t}=e;return(0,a.jsx)(u,{roomId:t.roomId})}}},function(e){e.O(0,[942,492,971,23,744],function(){return e(e.s=3611)}),_N_E=e.O()}]);